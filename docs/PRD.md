# 可溯源网络数据采集平台 - 产品需求文档 (PRD)

**文档密级**：内部公开  
**目标读者**：产品经理 / 技术 Leader / 业务方  
**核心目标**：构建一个抗干扰、高鲁棒、全审计的分布式采集系统。在非稳态（随时中断）环境下，通过智能哈希去重最大化降低成本，同时确保合规溯源。

> **技术实现详情**：请参阅 [SPEC.md](./SPEC.md)

---

## 1. 项目背景与目标

### 1.1 业务背景

在网络数据采集场景中，需要解决以下核心问题：
- **合规溯源**：证明数据来源的真实性和完整性
- **成本控制**：避免重复采集和存储未变化的内容
- **稳定可靠**：在随时可能中断的环境下保证数据不丢失

### 1.2 核心目标

| 目标 | 说明 |
|------|------|
| **抗干扰** | 屏蔽广告、弹窗等视觉噪音，确保采集结果稳定 |
| **智能去重** | 仅当页面发生实质变化时才存储新快照 |
| **全量审计** | 每次采集都记录日志，支持回溯分析 |
| **高可用** | 任务不丢失，支持断点续传和故障恢复 |

---

## 2. 基础设施概述

### 2.1 存储架构

| 存储类型 | 用途 |
|----------|------|
| **Aliyun OSS** | 存储页面快照文件 (DOM、截图、MHTML) |
| **PostgreSQL** | 存储任务队列、状态机、审计日志 |

### 2.2 浏览器环境

- 使用 Playwright 进行页面渲染
- 加载去广告和去弹窗插件，确保页面干净
- 使用反检测技术规避爬虫识别

---

## 3. 核心服务模块

系统由三个独立服务组成，通过数据库解耦：

| 服务 | 职责 |
|------|------|
| **Scheduler (调度器)** | 任务生产、故障恢复、全局流控 |
| **Worker (采集器)** | 执行浏览器操作、计算哈希、上传快照 |
| **Extractor (解析器)** | 从快照中提取结构化业务数据 |

---

## 4. 核心业务流程

Worker 采集流程遵循 **幂等性** 和 **可重入性** 原则：

### Step 1: 获取任务
从数据库获取待处理任务，应用乱序和域名频控策略。

### Step 2: 页面渲染
启动浏览器访问目标 URL，等待页面加载完成。

### Step 3: 计算哈希
使用 **Clean Hash 算法** 计算页面指纹。该算法会过滤广告、脚本等噪音，仅保留核心内容。

> 算法详情参见 [SPEC.md - 4.1 Clean Hash 算法](./SPEC.md#41-clean-hash-算法)

### Step 4: 决策门禁

| 场景 | 条件 | 操作 |
|------|------|------|
| **无变化** | 当前哈希 = 上次哈希 | 仅记录审计日志，跳过存储 |
| **有变化** | 当前哈希 ≠ 上次哈希 | 生成快照文件，上传至 OSS |

### Step 5: 原子提交
更新数据库状态，释放任务进入下一轮调度。

---

## 5. 数据模型概述

系统使用四张核心表：

| 表名 | 职责 |
|------|------|
| **page** | URL 资产与调度状态 |
| **page_snapshot** | 快照存档 (仅变更时写入) |
| **page_monitor** | 监测审计日志 (每次都写入) |
| **page_info** | 结构化数据提取结果 |

> 详细字段设计参见 [SPEC.md - 3. 数据库详细设计](./SPEC.md#3-数据库详细设计)

---

## 6. 非功能特性

### 6.1 可中断与恢复

- **心跳机制**：Worker 定期上报心跳
- **僵尸回收**：调度器定期检测超时任务并回收重试

### 6.2 乱序与防爬

- 任务获取随机排序，避免固定访问模式
- 依赖浏览器插件屏蔽行为检测

### 6.3 数据一致性

- **写入顺序**：先写 OSS → 后写 DB
- **失败处理**：OSS 失败时不更新 DB，等待自动重试

---

## 7. 开发阶段规划

### Phase 1: 核心功能

- 集成 Playwright + 插件环境
- 实现 Worker 核心：Clean Hash 算法 + OSS 上传
- 实现基础 DB 交互：取任务 → 执行 → 写审计日志

### Phase 2: 可靠性增强

- 实现 Heartbeat 和 Zombie Reaper 机制
- 实现基于域名的乱序调度策略

### Phase 3: 数据提取

- 集成 Extractor 解析引擎
- 监听快照表新记录进行数据提取